# ProcessAudit AI - Service Discovery Configuration
# Advanced monitoring integration points for dynamic service discovery

# Consul Service Discovery (Optional)
consul_configs:
  - server: 'consul:8500'
    services:
      - 'processaudit-api'
      - 'processaudit-workers'
      - 'processaudit-pdf-service'
    tags:
      - 'production'
      - 'monitoring'
    allow_stale: true
    refresh_interval: 30s

# Kubernetes Service Discovery (if deploying to K8s)
kubernetes_sd_configs:
  - role: pod
    namespaces:
      names:
        - processaudit-production
        - processaudit-staging
    selectors:
      - role: "pod"
        label: "app.kubernetes.io/name=processaudit"

# File-based Service Discovery for Dynamic Targets
file_sd_configs:
  - files:
      - '/etc/prometheus/dynamic/*.yml'
      - '/etc/prometheus/targets/*.json'
    refresh_interval: 30s

# Docker Swarm Service Discovery
dockerswarm_sd_configs:
  - host: unix:///var/run/docker.sock
    role: services
    filters:
      - name: label
        values: ["com.processaudit.monitoring=true"]
    refresh_interval: 60s

# EC2 Instance Discovery (for AWS deployments)
ec2_sd_configs:
  - region: us-east-1
    port: 9100
    filters:
      - name: tag:Project
        values: [processaudit-ai]
      - name: tag:Environment
        values: [production, staging]
      - name: instance-state-name
        values: [running]
    refresh_interval: 60s

# Eureka Service Discovery (if using Spring Cloud)
eureka_sd_configs:
  - server: 'http://eureka:8761/eureka'
    refresh_interval: 30s

# Custom HTTP Service Discovery
http_sd_configs:
  - url: 'http://host.docker.internal:3000/api/monitoring/targets'
    refresh_interval: 60s

# Relabeling Rules for Service Discovery
relabel_configs:
  # Standard service labeling
  - source_labels: [__meta_consul_service]
    target_label: service
  - source_labels: [__meta_consul_tags]
    regex: '.*,environment=([^,]+),.*'
    target_label: environment
  - source_labels: [__meta_consul_tags]
    regex: '.*,version=([^,]+),.*'
    target_label: version

  # Kubernetes pod labeling
  - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
    target_label: app
  - source_labels: [__meta_kubernetes_namespace]
    target_label: namespace
  - source_labels: [__meta_kubernetes_pod_name]
    target_label: pod

  # Docker Swarm service labeling
  - source_labels: [__meta_dockerswarm_service_label_com_processaudit_component]
    target_label: component
  - source_labels: [__meta_dockerswarm_service_name]
    target_label: service_name

  # EC2 instance labeling
  - source_labels: [__meta_ec2_tag_Name]
    target_label: instance_name
  - source_labels: [__meta_ec2_tag_Environment]
    target_label: environment
  - source_labels: [__meta_ec2_instance_id]
    target_label: instance_id

# Metric Relabeling for Consistency
metric_relabel_configs:
  # Standardize service labels across all metrics
  - source_labels: [service]
    regex: '(processaudit-.*)'
    target_label: service_family
    replacement: 'processaudit'

  # Add deployment information
  - source_labels: [environment, version]
    separator: '-'
    target_label: deployment

  # Normalize instance labels
  - source_labels: [instance]
    regex: '(.*):.*'
    target_label: host
    replacement: '${1}'